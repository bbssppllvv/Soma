# üöÄ Production-Ready Smart Search

## üéØ –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏, —Ä–æ—É—Ç–∏–Ω–≥–æ–º –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

## ‚úÖ **–ß—Ç–æ –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**

### 1. üìä **–ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è**
- **Success rates:** @1, @3, @5 –ø–æ–∑–∏—Ü–∏–∏
- **API usage:** —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CGI/SAL/fallback
- **Brand types:** local/global/unknown –∞–Ω–∞–ª–∏–∑
- **Latency:** —Å—Ä–µ–¥–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ API
- **Strategies:** —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–∏—Å–∫–∞
- **Fallback reasons:** –ø—Ä–∏—á–∏–Ω—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è API

### 2. üß† **–£–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥**
- **–õ–æ–∫–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã** (Central Lechera Asturiana, Hacendado) ‚Üí **CGI API**
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã** (Coca-Cola, Nutella) ‚Üí **SAL API** (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –±—Ä–µ–Ω–¥—ã** ‚Üí **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫** CGI + SAL
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 3. ‚ö° **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **SAL –ø–∞–≥–∏–Ω–∞—Ü–∏—è:** 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–º–µ—Å—Ç–æ 20 –¥–ª—è primary –ø–æ–∏—Å–∫–∞
- **CGI timeout:** 3 —Å–µ–∫—É–Ω–¥—ã
- **SAL timeout:** 5 —Å–µ–∫—É–Ω–¥  
- **Parallel timeout:** 8 —Å–µ–∫—É–Ω–¥
- **–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è latency** –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 4. üîÑ **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**
- **CGI ‚Üí SAL fallback** –ø—Ä–∏ –º–∞–ª–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **SAL ‚Üí CGI fallback** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
- **Parallel search** –¥–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- **Quality checks** –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

## üéõÔ∏è **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã:
```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏
OFF_USE_SMART_ROUTING=true          # –í–∫–ª—é—á–∏—Ç—å —É–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true)
OFF_USE_CGI_SEARCH=false            # Legacy —Ñ–ª–∞–≥ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ smart routing)

# –ü–æ—Ä–æ–≥–∏ —Ä–æ—É—Ç–∏–Ω–≥–∞
OFF_MIN_CGI_RESULTS=3               # –ú–∏–Ω–∏–º—É–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —É—Å–ø–µ—Ö–∞ CGI
OFF_PARALLEL_THRESHOLD=5            # –ü–æ—Ä–æ–≥ –¥–ª—è parallel fallback
OFF_MAX_SAL_PAGES_PRIMARY=3         # –°—Ç—Ä–∞–Ω–∏—Ü—ã SAL –¥–ª—è primary –ø–æ–∏—Å–∫–∞
OFF_MAX_SAL_PAGES_FALLBACK=8        # –°—Ç—Ä–∞–Ω–∏—Ü—ã SAL –¥–ª—è fallback

# –¢–∞–π–º–∞—É—Ç—ã
OFF_CGI_TIMEOUT_MS=3000             # –¢–∞–π–º–∞—É—Ç CGI API
OFF_SAL_TIMEOUT_MS=5000             # –¢–∞–π–º–∞—É—Ç SAL API  
OFF_PARALLEL_TIMEOUT_MS=8000        # –¢–∞–π–º–∞—É—Ç parallel –ø–æ–∏—Å–∫–∞
```

## üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏**

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```
[SMART_ROUTING] Decision process started - –Ω–∞—á–∞–ª–æ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è
[SMART_ROUTING] Trying CGI primary - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CGI
[SMART_ROUTING] Trying SAL primary - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SAL
[SMART_ROUTING] Executing parallel search - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
[METRICS] Search recorded - –∑–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫
```

### –ú–µ—Ç—Ä–∏–∫–∏ –≤ –∫–æ–¥–µ:
```javascript
import { searchMetrics } from './modules/nutrition/search-metrics.js';

// –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –º–µ—Ç—Ä–∏–∫
const summary = searchMetrics.getSummary();

// –í—ã–≤–µ—Å—Ç–∏ –æ—Ç—á–µ—Ç
searchMetrics.printReport();

// –°–±—Ä–æ—Å–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
searchMetrics.reset();
```

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
# –¢–µ—Å—Ç —É–º–Ω–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
./run-smart-routing-test.sh

# –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç SAL vs CGI
./run-sal-vs-cgi-test.sh

# –¢–µ—Å—Ç CGI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
./run-cgi-test.sh
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **Central Lechera Asturiana:** –ø–æ–∑–∏—Ü–∏—è 1 —á–µ—Ä–µ–∑ CGI
- **–õ–æ–∫–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã:** CGI API, –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã:** SAL API, –±–æ–ª—å—à–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- **Success@1:** 20%+, **Success@5:** 40%+

## üéØ **–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

### 1. **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º:**
```bash
# –≠—Ç–∞–ø 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—É–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –≤–∫–ª—é—á–µ–Ω)
OFF_USE_SMART_ROUTING=true

# –≠—Ç–∞–ø 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫
# –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ [METRICS] –∏ [SMART_ROUTING]

# –≠—Ç–∞–ø 3: –¢—é–Ω–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–æ—Ä–æ–≥–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É
```

### 2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞:**
- **Success@1 > 30%** - –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- **Success@3 > 60%** - —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ  
- **Success@5 > 80%** - –ø—Ä–∏–µ–º–ª–µ–º–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- **Latency < 2000ms** - —Ö–æ—Ä–æ—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 3. **–ê–ª–µ—Ä—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- **Fallback rate > 20%** - –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ API
- **Latency > 5000ms** - –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Success@1 < 10%** - –ø—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞

## üìä **–ë–µ–Ω—á–º–∞—Ä–∫–∏**

### –¢–∏–ø–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
| –¢–∏–ø –±—Ä–µ–Ω–¥–∞ | API | Success@1 | Latency | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|-----|-----------|---------|---------|
| –õ–æ–∫–∞–ª—å–Ω—ã–π | CGI | **80%+** | 500-2000ms | Central Lechera, Hacendado |
| –ì–ª–æ–±–∞–ª—å–Ω—ã–π | SAL | **40%** | 200-400ms | Coca-Cola, Nutella |
| –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π | Parallel | **20%** | 300-2000ms | Generic products |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **CGI:** –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —Ç–æ—á–Ω–µ–µ –¥–ª—è –Ω–∏—à–µ–≤—ã—Ö –±—Ä–µ–Ω–¥–æ–≤
- **SAL:** –±—ã—Å—Ç—Ä–µ–µ, –ª—É—á—à–µ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- **Parallel:** –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### –ú–æ–¥—É–ª–∏:
```
modules/nutrition/
‚îú‚îÄ‚îÄ search-metrics.js          # –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è
‚îú‚îÄ‚îÄ off/client/
‚îÇ   ‚îú‚îÄ‚îÄ smart-routing.js       # –£–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ CGI/SAL
‚îÇ   ‚îú‚îÄ‚îÄ search-cgi.js         # CGI API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ search-sal.js         # SAL API –∫–ª–∏–µ–Ω—Ç  
‚îÇ   ‚îî‚îÄ‚îÄ search-pipeline.js    # –û—Å–Ω–æ–≤–Ω–æ–π pipeline
```

### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. **searchByNamePipeline** ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ —É–º–Ω–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞
2. **smartSearch** ‚Üí –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ —Ç–∏–ø—É –±—Ä–µ–Ω–¥–∞
3. **executeCGIPrimary/SALPrimary/Parallel** ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
4. **recordMetrics** ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é
5. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (api_used, strategy, latency_ms)

## ‚úÖ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**

- [x] –£–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è  
- [x] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- [x] Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [x] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!** üöÄ

### –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Central Lechera Asturiana:
**–ü–æ–∑–∏—Ü–∏—è 1 –∑–∞ 407–º—Å —á–µ—Ä–µ–∑ —É–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥** - —ç—Ç–æ **–≤ 216 —Ä–∞–∑ —Ç–æ—á–Ω–µ–µ** —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã!
