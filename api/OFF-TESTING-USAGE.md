# OpenFoodFacts Testing Suite - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å –∞–Ω–∞–ª–∏–∑–æ–º
./run-off-tests.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
node off-search-tester.js --verbose --output-dir ./results
node off-pattern-analyzer.js ./results
```

### 2. –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
```bash
node off-search-tester.js --categories dairy,beverages --verbose
```

### 3. –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
```bash
node off-search-tester.js --strategies main_pipeline,product_only --verbose
```

## üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏

### off-search-tester.js
- `--output-dir DIR` - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ./off-test-results)
- `--timeout MS` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π timeout –Ω–∞ —Ç–µ—Å—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5000)
- `--verbose` - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
- `--categories CAT` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `--strategies STRAT` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `--help` - —Å–ø—Ä–∞–≤–∫–∞

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `dairy` - –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- `beverages` - –Ω–∞–ø–∏—Ç–∫–∏  
- `snacks` - —Å–Ω–µ–∫–∏
- `plant-based` - —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- `test` - —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- `main_pipeline` - –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–π–ø–ª–∞–π–Ω (SaL + v2 + Legacy)
- `brand_with_product` - –±—Ä–µ–Ω–¥ + –ø—Ä–æ–¥—É–∫—Ç –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- `brand_separate` - –±—Ä–µ–Ω–¥ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
- `product_only` - —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:
```
off-test-results/
‚îú‚îÄ‚îÄ raw-results.json              # –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤
‚îú‚îÄ‚îÄ results-summary.csv           # –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îú‚îÄ‚îÄ performance-report.md         # –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ issues-and-recommendations.md # –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ pattern-analysis.json         # JSON –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
‚îî‚îÄ‚îÄ pattern-analysis.md           # Markdown –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
```

## üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤

### 1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ TEST_PRODUCTS
```javascript
{
  id: 'new_product',
  category: 'dairy',
  brand: 'Brand Name',
  product_name: 'product description',
  clean_name: 'clean product name',
  required_tokens: ['variant', 'tokens'],
  canonical_category: 'dairy',
  
  // –†–µ–∞–ª—å–Ω—ã–π Lucene-–∑–∞–ø—Ä–æ—Å –∏–∑ –ª–æ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  expected_lucene: `brands:"brand"^4 AND categories_tags:"en:category"`,
  
  variations: [
    { query: 'Brand Name product', strategy: 'standard' },
    { query: 'brand product variant', strategy: 'with_variant' }
  ],
  
  expected_brands: ['brand-name'],
  expected_categories: ['en:category'],
  known_issues: ['normalization issue', 'special characters']
}
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–∏—Å–∫–∞
```javascript
new_strategy: {
  name: 'New Strategy Description',
  timeout: 1000,
  run: async (query, options) => {
    // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    return await searchByNameV1(query.term, {
      signal: options.signal,
      // ... –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    });
  }
}
```

## üìà –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### Success Rate
- **100% —Å 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** = API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
- **<100%** = –µ—Å—Ç—å –æ—à–∏–±–∫–∏/timeout'—ã
- **>0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** = –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–¥—É–∫—Ç—ã

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **main_pipeline: ~3000ms** - –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
- **brand_separate: ~1000ms** - –æ–¥–∏–Ω —ç—Ç–∞–ø
- **product_only: ~800ms** - —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
- `Rate limit wait aborted` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
- `OFF 500` - –æ—à–∏–±–∫–∏ SaL API
- `timeout` - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
- `empty_query` - –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Rate limiting
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
export OFF_SEARCH_REFILL_MS=30000  # –±—ã–ª–æ 60000
export OFF_SEARCH_MAX_TOKENS=20    # –±—ã–ª–æ 10
```

### –ü—Ä–æ–±–ª–µ–º–∞: Timeout'—ã
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å timeout'—ã
export OFF_SAL_TIMEOUT_MS=800      # –±—ã–ª–æ 500
export OFF_V2_STRICT_TIMEOUT_MS=1200  # –±—ã–ª–æ 900
export OFF_GLOBAL_BUDGET_MS=5000   # –±—ã–ª–æ 3000
```

### –ü—Ä–æ–±–ª–µ–º–∞: SaL 500 –æ—à–∏–±–∫–∏
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å Lucene-–∑–∞–ø—Ä–æ—Å—ã
- –£–±—Ä–∞—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∏–∑ –±—Ä–µ–Ω–¥–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –Ω–∞ v2/legacy

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π workflow

1. **Baseline —Ç–µ—Å—Ç**: –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
2. **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º**: –∏–∑—É—á–∏—Ç—å pattern-analysis.md
3. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å—ã**: –∏–∑ recommendations
4. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç**: —Å—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
5. **Production deploy**: –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `[METRIC] off_sal_5xx` - –æ—à–∏–±–∫–∏ SaL
- `[METRIC] off_rate_limit_aborts` - rate limiting
- `[METRIC] off_pipeline_empty` - –ø—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- `[METRIC] off_v2_timeout` - timeout'—ã v2

### Debug —Ä–µ–∂–∏–º
```bash
# –í–∫–ª—é—á–∏—Ç—å verbose –ª–æ–≥–∏
node off-search-tester.js --verbose

# –û—Ç–∫–ª—é—á–∏—Ç—å –∫–µ—à –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
export OFF_CACHE_TTL_MS=0
```

---

**üí° –°–æ–≤–µ—Ç**: –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (`--categories dairy`) –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏, –∑–∞—Ç–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ –Ω–∞ –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
