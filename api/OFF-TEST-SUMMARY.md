# OpenFoodFacts API Testing Suite - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç

## üéØ –¶–µ–ª—å
–°–∏—Å—Ç–µ–º–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É OFF API –Ω–∞ —Ç–∏–ø–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö, –≤—ã—è–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –æ—à–∏–±–æ–∫ –∏ –ø–æ–ª—É—á–∏—Ç—å –∂–∏–≤—É—é –º–∞—Ç—Ä–∏—Ü—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:** 11
- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ API-–≤—ã–∑–æ–≤–æ–≤:** 236
- **–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 341.6 —Å–µ–∫—É–Ω–¥
- **Success Rate:** 100% (–Ω–æ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!)

### üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤—ã—è–≤–ª–µ–Ω—ã

#### 1. Rate Limiting –∏ Timeouts
```
[METRIC] off_rate_limit_aborts - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏
[OFF] search v2 error - Rate limit wait aborted
[OFF] legacy search aborted - Rate limit wait aborted
```

#### 2. SaL API (Search-a-licious) –ø—Ä–æ–±–ª–µ–º—ã
```
[OFF] POST error 500 (https://search.openfoodfacts.org/search)
[METRIC] off_sal_5xx - Internal Server Error
```

#### 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±—Ä–µ–Ω–¥–æ–≤
- **M&M's** ‚Üí –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞–º–∏ –∏ –∞–º–ø–µ—Ä—Å–∞–Ω–¥–∞–º–∏
- **Ben & Jerry's** ‚Üí –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
- **Central Lechera Asturiana** ‚Üí –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
- **Coca-Cola** ‚Üí –¥–µ—Ñ–∏—Å—ã vs –ø—Ä–æ–±–µ–ª—ã

## üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ—à–∏–±–æ–∫
1. **Rate Limiting**: –°–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–∑—É —É–ø–∏—Ä–∞–µ—Ç—Å—è –≤ –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
2. **SaL 500 –æ—à–∏–±–∫–∏**: Lucene-–∑–∞–ø—Ä–æ—Å—ã –≤—ã–∑—ã–≤–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
3. **Timeout cascade**: –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
4. **Brand fragmentation**: –°–ª–æ–∂–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –ª–æ–º–∞—é—Ç –ø–æ–∏—Å–∫

### Lucene Query Problems
```lucene
// –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
brands:"Ben & Jerry's"^4 AND categories_tags:"en:ice-creams" 
AND (product_name:("cookie dough"~2^3) OR product_name:("cookie"^1.5 OR "dough"^1.5))

// –†–µ–∑—É–ª—å—Ç–∞—Ç: 500 Internal Server Error
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **main_pipeline**: 3000ms (–ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Å fallback)
- **brand_with_product**: 1000ms (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
- **product_only**: 800ms (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. **–£–≤–µ–ª–∏—á–∏—Ç—å timeout'—ã**:
   - SaL: 500ms ‚Üí 800ms+
   - v2 strict: 900ms ‚Üí 1200ms
   - Legacy: 400ms ‚Üí 600ms

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –±—Ä–µ–Ω–¥–æ–≤**:
   ```javascript
   function normalizeBrand(brand) {
     return brand
       .replace(/&/g, 'and')
       .replace(/'/g, '')
       .replace(/-/g, ' ')
       .toLowerCase()
       .trim();
   }
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å rate limiting protection**:
   ```javascript
   const RATE_LIMIT_DELAY = 100; // ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
   const MAX_CONCURRENT = 2; // –º–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   ```

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
4. **–£–ø—Ä–æ—Å—Ç–∏—Ç—å Lucene-–∑–∞–ø—Ä–æ—Å—ã** –¥–ª—è SaL API
5. **–î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –ø—Ä–∏ 500 –æ—à–∏–±–∫–∞—Ö
6. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** - –º–Ω–æ–≥–∏–µ –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
7. **–î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
8. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## üõ†Ô∏è –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Rate Limiting
```javascript
// –í off-client.js, —É–≤–µ–ª–∏—á–∏—Ç—å bucket capacity
const SEARCH_BUCKET_CAPACITY = 20; // –±—ã–ª–æ 10
const SEARCH_BUCKET_REFILL_MS = 30000; // –±—ã–ª–æ 60000
```

### 2. Timeouts
```javascript
// –£–≤–µ–ª–∏—á–∏—Ç—å –≤—Å–µ timeout'—ã –≤ 1.5-2 —Ä–∞–∑–∞
const SAL_TIMEOUT_MS = 800; // –±—ã–ª–æ 500
const V2_STRICT_TIMEOUT_MS = 1200; // –±—ã–ª–æ 900
const LEGACY_TIMEOUT_MS = 600; // –±—ã–ª–æ 400
```

### 3. Brand Normalization
```javascript
// –£–ª—É—á—à–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é toBrandSlug
function toBrandSlug(value) {
  return canonicalizeQuery(value || '')
    .replace(/&/g, 'and')
    .replace(/'/g, '')
    .replace(/-/g, ' ')
    .replace(/\s+/g, '-')
    .toLowerCase();
}
```

### 4. SaL Error Handling
```javascript
// –î–æ–±–∞–≤–∏—Ç—å fallback –ø—Ä–∏ 500 –æ—à–∏–±–∫–∞—Ö
if (error?.status >= 500) {
  console.log('[OFF] SaL 5xx error, skipping to v2');
  return null; // Skip to next stage
}
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

1. **off_sal_5xx** - –æ—à–∏–±–∫–∏ SaL API
2. **off_rate_limit_aborts** - –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤
3. **off_pipeline_empty** - –ø—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
4. **off_v2_timeout** - timeout'—ã v2 API

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –≤—ã—à–µ
2. üîÑ **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã** —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
3. üìä **–°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** –¥–æ/–ø–æ—Å–ª–µ
4. üöÄ **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω** –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π

## üìÅ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `raw-results.json` - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤
- `results-summary.csv` - —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `performance-report.md` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- `pattern-analysis.md` - –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- `issues-and-recommendations.md` - –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

---

**–í—ã–≤–æ–¥**: OFF API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä—å–µ–∑–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting'–∞, timeout'–æ–≤ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±—Ä–µ–Ω–¥–æ–≤. –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
