# ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—á–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞

## üéØ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### 1. ‚úÖ **–ë–î: –ï–¥–∏–Ω—ã–π UUID –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
**–§–∞–π–ª**: `db_migration_uuid_keys.sql`
- UUID –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á –≤ `users`
- FK —Å–≤—è–∑—å `entries.user_uuid ‚Üí users.id`
- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å `telegram_user_id`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î–∂–æ–π–Ω—ã –Ω–µ –ª–æ–º–∞—é—Ç—Å—è, —Å–≤—è–∑–∏ –Ω–∞–¥–µ–∂–Ω—ã–µ

### 2. ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π**
**–í–∫–ª—é—á–µ–Ω–æ –≤**: `db_migration_uuid_keys.sql`
```sql
ALTER TABLE entries ADD CONSTRAINT uniq_chat_msg UNIQUE (chat_id, message_id);
```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î—É–±–ª–∏–∫–∞—Ç—ã –æ—Ç Telegram –∏—Å–∫–ª—é—á–µ–Ω—ã

### 3. ‚úÖ **OFF: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ serving-only –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
**–§–∞–π–ª**: `api/modules/nutrition/off-map.js`
- –ü–∞—Ä—Å–∏–Ω–≥ `serving_size` (–Ω–∞–ø—Ä–∏–º–µ—Ä "150g")
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è serving ‚Üí per-100g —á–µ—Ä–µ–∑ `to100 = v => (+v) * (100/grams)`
- Fallback –Ω–∞ per-100g –µ—Å–ª–∏ serving –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Coverage OFF —Å–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–µ–Ω

### 4. ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∫—ç—à–∞ (LRU-cap)**
**–§–∞–π–ª**: `api/modules/nutrition/simple-cache.js`
```javascript
const MAX_ITEMS = 1000;
// LRU: —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Serverless –≤–æ—Ä–∫–µ—Ä—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—é—Ç—Å—è

### 5. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è UPC –∏ –¥—Ä–æ–±–Ω—ã—Ö –ø–æ—Ä—Ü–∏–π**
**–§–∞–π–ª—ã**: 
- `api/modules/nutrition/off-resolver.js`: `normalizeUPC()`
- `api/modules/nutrition/units.js`: `parseNumberMaybeFraction()`

```javascript
// UPC: —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
normalizeUPC("12-345-67890") ‚Üí "1234567890"

// –î—Ä–æ–±–∏: ¬Ω ‚Üí 0.5
parseNumberMaybeFraction("1/2") ‚Üí 0.5
parseNumberMaybeFraction("150") ‚Üí 150
```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ú–µ–Ω—å—à–µ —Ñ–µ–π–ª–æ–≤ –ø–æ UPC, "¬Ω cup" –Ω–µ –ª–æ–º–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

### –ü–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º OFF:
1. **–í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î**: `psql < db_migration_uuid_keys.sql`
2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –≤—Å—Ç–∞–≤–∫–∏ entries**: –¥–æ–±–∞–≤–∏—Ç—å `ON CONFLICT (chat_id, message_id) DO NOTHING`
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã**:
   - "¬Ω cup milk" ‚Üí –¥–æ–ª–∂–µ–Ω –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - UPC —Å –¥–µ—Ñ–∏—Å–∞–º–∏ ‚Üí –¥–æ–ª–∂–µ–Ω –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è
   - Serving-only –ø—Ä–æ–¥—É–∫—Ç—ã ‚Üí –¥–æ–ª–∂–Ω—ã —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ:
```bash
OFF_ENABLED=true
OFF_ENABLED_PERCENT=10  # 10% —Ç—Ä–∞—Ñ–∏–∫–∞
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **Coverage**: –¥–æ–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ–∑–æ–ª–≤–æ–≤
- **P50 –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: < 2-3—Å
- **Ask-rate**: –¥–æ–ª—è needs_clarification
- **–õ–æ–≥–∏**: `OFF resolved X/Y items (Z%) in Nms`

---

## ‚ö° –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –º–∏–Ω–∏–º—É–º –¥–æ—Å—Ç–∏–≥–Ω—É—Ç

‚úÖ –ë–î —Å–≤—è–∑–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç—Å—è  
‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –∏—Å–∫–ª—é—á–µ–Ω—ã  
‚úÖ OFF –ø–æ–∫—Ä—ã–≤–∞–µ—Ç serving-only  
‚úÖ –ö—ç—à –Ω–µ —Ä–∞—Å–ø—É—Ö–∞–µ—Ç  
‚úÖ UPC/–¥—Ä–æ–±–∏ –Ω–µ –∫–æ—Å—è—á–∞—Ç  

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ OFF_ENABLED=true –Ω–∞ 10% —Ç—Ä–∞—Ñ–∏–∫–∞!** üéØ
